use std::cell::Cell;
use crate::native::reflection::{ObjectWrapper, UObject};
use crate::native::uworld::ENGINE_INDEX;
use crate::native::{ArrayWrapper, StructValueWrapper, UeScope, UFONTBULKDATA_INITIALIZE};
use std::sync::atomic::Ordering;
use std::mem;
use std::ops::RangeInclusive;
use itertools::any;

pub fn init() {
    UFont::set_font(UFont::get_font("LargeFont"));
}

pub struct UFont {
    font: *mut UFontUE
}

pub enum UFontUE {}

#[repr(C)]
struct UFontBulkData {
    // stub, we only need a pointer to this struct
}

impl UFont {
    pub fn get_font(name: &str) -> UFont {
        UeScope::with(|scope| {
            let engine = scope.get(ENGINE_INDEX.get().unwrap());
            let font = engine.get_field(name).unwrap::<ObjectWrapper>();
            if !font.class().extends_from("Font") {
                panic!(
                    "{} doesn't extend from Font",
                    font.class().name()
                );
            }
            UFont { font: font.as_ptr() as *mut UFontUE }
        })
    }

    pub fn set_font(font: UFont) {
        unsafe {
            let font = ObjectWrapper::new(font.font as *mut UObject);
            let composite = font.get_field("CompositeFont").unwrap::<StructValueWrapper>();
            let typefaces = composite.get_field("DefaultTypeface").unwrap::<StructValueWrapper>();
            let fonts = typefaces.get_field("Fonts").unwrap::<ArrayWrapper<StructValueWrapper>>();
            let font_entry = fonts.get(0).unwrap();
            let font_data = font_entry.get_field("Font").unwrap::<StructValueWrapper>();
            let bulk_data = font_data.get_field("BulkDataPtr").unwrap::<ObjectWrapper>();
            const CUSTOM_FONT_PTR: &'static [u8] = include_bytes!("../../DejaVuSansMono.ttf");
            let fun: extern_fn!(fn(this: *mut UFontBulkData, data: *const u8, int: i32)) = mem::transmute(UFONTBULKDATA_INITIALIZE.load(Ordering::SeqCst));
            fun(bulk_data.as_ptr() as *mut UFontBulkData, CUSTOM_FONT_PTR.as_ptr(), CUSTOM_FONT_PTR.len() as i32);
            // We set the font size to 32 to improve the look at high UI scales whilst maintaining readability at low UI scales.
            font.get_field("LegacyFontSize").unwrap::<&Cell<i32>>().set(32);
        }
    }
}

// TODO: figure out how to have fallback fonts rather than replacing unprintable characters
const DEJAVU_SANS_MONO_UNICODE_RANGES: [RangeInclusive<u32>; 258] = [
    0x20..=0x7e, 0xa0..=0x1c3, 0x1cd..=0x1e3, 0x1e6..=0x1f0, 0x1f4..=0x1f6, 0x1f8..=0x1f9, 0x1fc..=0x221, 0x224..=0x241, 0x243..=0x245, 0x24c..=0x24d, 0x250..=0x2b9, 0x2bb..=0x2c1,
    0x2c6..=0x2c9, 0x2cc..=0x2d3, 0x2d6..=0x2de, 0x2e0..=0x2e9, 0x2ee..=0x2ee, 0x2f3..=0x2f3, 0x300..=0x33f, 0x343..=0x343, 0x358..=0x358, 0x361..=0x361, 0x374..=0x375, 0x37a..=0x37a,
    0x37e..=0x37e, 0x384..=0x38a, 0x38c..=0x38c, 0x38e..=0x3a1, 0x3a3..=0x3ce, 0x3d0..=0x3e1, 0x3f0..=0x45f, 0x462..=0x463, 0x472..=0x473, 0x490..=0x49b, 0x4a2..=0x4a5, 0x4aa..=0x4b3,
    0x4ba..=0x4bb, 0x4c0..=0x4c4, 0x4c7..=0x4c8, 0x4cb..=0x4cc, 0x4cf..=0x4f9, 0x510..=0x511, 0x51a..=0x51d, 0x531..=0x556, 0x559..=0x55f, 0x561..=0x587, 0x589..=0x58a, 0x606..=0x607,
    0x609..=0x60a, 0x60c..=0x60c, 0x615..=0x615, 0x61b..=0x61b, 0x61f..=0x61f, 0x621..=0x63a, 0x640..=0x655, 0x65a..=0x65a, 0x660..=0x66d, 0x674..=0x674, 0x679..=0x67b, 0x67e..=0x680,
    0x683..=0x684, 0x686..=0x687, 0x691..=0x691, 0x698..=0x698, 0x6a4..=0x6a4, 0x6a9..=0x6a9, 0x6af..=0x6af, 0x6be..=0x6be, 0x6cc..=0x6cc, 0x6f0..=0x6f9, 0xe81..=0xe82, 0xe84..=0xe84,
    0xe87..=0xe88, 0xe8a..=0xe8a, 0xe8d..=0xe8d, 0xe94..=0xe97, 0xe99..=0xe9f, 0xea1..=0xea3, 0xea5..=0xea5, 0xea7..=0xea7, 0xeaa..=0xeab, 0xead..=0xeb9, 0xebb..=0xebc, 0xec8..=0xecd,
    0x10d0..=0x10fc, 0x1d02..=0x1d02, 0x1d08..=0x1d09, 0x1d14..=0x1d14, 0x1d16..=0x1d17, 0x1d1d..=0x1d1f, 0x1d2c..=0x1d2e, 0x1d30..=0x1d3c, 0x1d3e..=0x1d5b, 0x1d62..=0x1d65, 0x1d77..=0x1d78,
    0x1d7b..=0x1d7b, 0x1d85..=0x1d85, 0x1d9b..=0x1db7, 0x1db9..=0x1dbf, 0x1e00..=0x1e13, 0x1e18..=0x1e2d, 0x1e30..=0x1e4d, 0x1e54..=0x1e63, 0x1e68..=0x1e79, 0x1e7c..=0x1e99, 0x1e9b..=0x1e9b,
    0x1e9f..=0x1ea1, 0x1eac..=0x1ead, 0x1eb0..=0x1eb1, 0x1eb6..=0x1eb9, 0x1ebc..=0x1ebd, 0x1ec6..=0x1ec7, 0x1eca..=0x1ecd, 0x1ed8..=0x1edd, 0x1ee0..=0x1ee5, 0x1ee8..=0x1eeb, 0x1eee..=0x1ef5,
    0x1ef8..=0x1ef9, 0x1f00..=0x1f15, 0x1f18..=0x1f1d, 0x1f20..=0x1f45, 0x1f48..=0x1f4d, 0x1f50..=0x1f57, 0x1f59..=0x1f59, 0x1f5b..=0x1f5b, 0x1f5d..=0x1f5d, 0x1f5f..=0x1f7d, 0x1f80..=0x1fb4,
    0x1fb6..=0x1fc4, 0x1fc6..=0x1fd3, 0x1fd6..=0x1fdb, 0x1fdd..=0x1fef, 0x1ff2..=0x1ff4, 0x1ff6..=0x1ffe, 0x2000..=0x200a, 0x2010..=0x2023, 0x2026..=0x2026, 0x202f..=0x2037, 0x2039..=0x203a,
    0x203c..=0x203e, 0x2045..=0x2049, 0x204b..=0x204b, 0x205f..=0x205f, 0x2070..=0x2071, 0x2074..=0x208e, 0x2090..=0x209c, 0x20a0..=0x20b5, 0x20b8..=0x20b9, 0x2102..=0x2102, 0x2105..=0x2105,
    0x210d..=0x210f, 0x2115..=0x2117, 0x2119..=0x211a, 0x211d..=0x211d, 0x2122..=0x2122, 0x2124..=0x2124, 0x2126..=0x2126, 0x212a..=0x212b, 0x212e..=0x212e, 0x2148..=0x2148, 0x2153..=0x215f,
    0x2190..=0x220d, 0x220f..=0x220f, 0x2211..=0x2213, 0x2215..=0x2215, 0x2217..=0x2220, 0x2227..=0x222d, 0x2234..=0x223d, 0x2241..=0x2269, 0x226d..=0x228b, 0x228f..=0x2292, 0x2295..=0x22a5,
    0x22c5..=0x22c6, 0x22cd..=0x22cd, 0x22da..=0x22e9, 0x22ef..=0x22ef, 0x2300..=0x2306, 0x2308..=0x2315, 0x2318..=0x2319, 0x231c..=0x2321, 0x2325..=0x2328, 0x232b..=0x232b, 0x2335..=0x2335,
    0x2337..=0x233e, 0x2341..=0x2344, 0x2347..=0x2349, 0x234b..=0x234d, 0x2350..=0x2350, 0x2352..=0x2354, 0x2357..=0x235c, 0x235e..=0x2360, 0x2363..=0x2365, 0x2368..=0x2369, 0x236b..=0x2370,
    0x2373..=0x237a, 0x237d..=0x237d, 0x2380..=0x2383, 0x2388..=0x238b, 0x2395..=0x2395, 0x239b..=0x23ae, 0x23ce..=0x23cf, 0x2423..=0x2423, 0x2500..=0x262f, 0x2638..=0x268b, 0x2690..=0x269c,
    0x26a0..=0x26a1, 0x26b0..=0x26b1, 0x2701..=0x2704, 0x2706..=0x2709, 0x270c..=0x2727, 0x2729..=0x274b, 0x274d..=0x274d, 0x274f..=0x2752, 0x2756..=0x2756, 0x2758..=0x275e, 0x2761..=0x2775,
    0x2794..=0x2794, 0x2798..=0x27af, 0x27b1..=0x27be, 0x27c2..=0x27c2, 0x27c5..=0x27c6, 0x27e0..=0x27e0, 0x27e6..=0x27e9, 0x29eb..=0x29eb, 0x29fa..=0x29fb, 0x2a2f..=0x2a2f, 0x2a6a..=0x2a6b,
    0x2b05..=0x2b0d, 0x2b12..=0x2b1a, 0x2c64..=0x2c64, 0x2c6d..=0x2c70, 0x2c75..=0x2c77, 0x2c79..=0x2c7a, 0x2c7c..=0x2c7f, 0x2e18..=0x2e18, 0x2e1f..=0x2e1f, 0x2e22..=0x2e25, 0x2e2e..=0x2e2e,
    0xa708..=0xa716, 0xa71b..=0xa71f, 0xa722..=0xa727, 0xa789..=0xa78e, 0xa790..=0xa791, 0xa7aa..=0xa7aa, 0xf6c5..=0xf6c5, 0xfb01..=0xfb02, 0xfb52..=0xfb81, 0xfb8a..=0xfb95, 0xfb9e..=0xfb9f,
    0xfbaa..=0xfbad, 0xfbe8..=0xfbe9, 0xfbfc..=0xfbff, 0xfe70..=0xfe74, 0xfe76..=0xfefc, 0xfeff..=0xfeff, 0xfff9..=0xfffd, 0x1d55a..=0x1d55a, 0x1d670..=0x1d6a3
];

const REPLACEMENT_CHAR: char = 'ï¿½';

fn default_font_can_render_character(character: char) -> bool {
    let value = character as u32;
    any(DEJAVU_SANS_MONO_UNICODE_RANGES, |range| range.contains(&value))
}

pub fn replace_unrenderable_chars(string: String) -> String {
    string.chars()
        .map(|c| if default_font_can_render_character(c) { c } else { REPLACEMENT_CHAR })
        .collect()
}